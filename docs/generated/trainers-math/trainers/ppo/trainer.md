# `trainers.ppo.trainer` Math-Annotated Source

_Source: `minerva/trainers/ppo/trainer.py`_

The full file is rendered in one continuous code-style block, with each `# LaTeX:` marker replaced inline by a rendered formula.

## Annotated Source

<div class="math-annotated-codeblock">
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> __future__ </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">annotations</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> os</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> random</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> time</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> typing </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">Tuple</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> gymnasium </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> gym</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> numpy </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> np</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch.nn </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> nn</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch.optim </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> optim</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> torch.distributions.normal </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">Normal</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> minerva.utils.running_norm </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">RunningNorm</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> minerva.utils.wandb_utils </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">log_wandb</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_resolve_env_id</span><span style="color: #F8F8F2">(env_id:</span> <span style="color: #F8F8F2">str)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">str:</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">env_id</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">startswith(</span><span style="color: #E6DB74">&quot;dm_control/&quot;</span><span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">parts</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">env_id</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">split(</span><span style="color: #E6DB74">&quot;/&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">len(parts)</span> <span style="color: #FF4689">!=</span> <span style="color: #AE81FF">3</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #E6DB74">&quot;Expected dm_control env id format &#39;dm_control/&lt;domain&gt;/&lt;task&gt;&#39;, &quot;</span></div>
  <div class="math-annotated-code-line">                <span style="color: #E6DB74">f&quot;got &#39;{</span><span style="color: #F8F8F2">env_id</span><span style="color: #E6DB74">}&#39;&quot;</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">_,</span> <span style="color: #F8F8F2">domain,</span> <span style="color: #F8F8F2">task</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">parts</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #E6DB74">f&quot;dm_control/{</span><span style="color: #F8F8F2">domain</span><span style="color: #E6DB74">}-{</span><span style="color: #F8F8F2">task</span><span style="color: #E6DB74">}-v0&quot;</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">env_id</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_make_env</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">gym_id:</span> <span style="color: #F8F8F2">str,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">seed:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line"><span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">thunk</span><span style="color: #F8F8F2">():</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">resolved_env_id</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">_resolve_env_id(gym_id)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">make(resolved_env_id)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">wrappers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">FlattenObservation(env)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">wrappers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">RecordEpisodeStatistics(env)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">wrappers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ClipAction(env)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Observation normalization is handled by RunningNorm inside the network.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">wrappers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">NormalizeReward(env)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">wrappers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">TransformReward(env,</span> <span style="color: #66D9EF">lambda</span> <span style="color: #F8F8F2">reward:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip(reward,</span> <span style="color: #FF4689">-</span><span style="color: #AE81FF">10</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">10</span><span style="color: #F8F8F2">))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reset(seed</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">seed)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed(seed)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">observation_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed(seed)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">env</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">thunk</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_extract_episode_stats</span><span style="color: #F8F8F2">(infos)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">list[tuple[int,</span> <span style="color: #F8F8F2">float,</span> <span style="color: #F8F8F2">float]]:</span></div>
  <div class="math-annotated-code-line"><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;Extract (env_index, episode_return, episode_length) from vector-env infos.&quot;&quot;&quot;</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">stats:</span> <span style="color: #F8F8F2">list[tuple[int,</span> <span style="color: #F8F8F2">float,</span> <span style="color: #F8F8F2">float]]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">isinstance(infos,</span> <span style="color: #F8F8F2">dict):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">stats</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">if</span> <span style="color: #E6DB74">&quot;episode&quot;</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">infos:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">episode</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">infos[</span><span style="color: #E6DB74">&quot;episode&quot;</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">ep_returns</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(episode[</span><span style="color: #E6DB74">&quot;r&quot;</span><span style="color: #F8F8F2">])</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">ep_lengths</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(episode[</span><span style="color: #E6DB74">&quot;l&quot;</span><span style="color: #F8F8F2">])</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">ep_mask</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">infos</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get(</span><span style="color: #E6DB74">&quot;_episode&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones_like(ep_returns,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">bool))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">idx</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">where(ep_mask)[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">]:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">stats</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append((int(idx),</span> <span style="color: #F8F8F2">float(ep_returns[idx]),</span> <span style="color: #F8F8F2">float(ep_lengths[idx])))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">stats</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">if</span> <span style="color: #E6DB74">&quot;final_info&quot;</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">infos:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">idx,</span> <span style="color: #F8F8F2">item</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">enumerate(infos[</span><span style="color: #E6DB74">&quot;final_info&quot;</span><span style="color: #F8F8F2">]):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">item</span> <span style="color: #FF4689">and</span> <span style="color: #E6DB74">&quot;episode&quot;</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">item:</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">episode_return</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(item[</span><span style="color: #E6DB74">&quot;episode&quot;</span><span style="color: #F8F8F2">][</span><span style="color: #E6DB74">&quot;r&quot;</span><span style="color: #F8F8F2">])</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">episode_length</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(item[</span><span style="color: #E6DB74">&quot;episode&quot;</span><span style="color: #F8F8F2">][</span><span style="color: #E6DB74">&quot;l&quot;</span><span style="color: #F8F8F2">])</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">stats</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append((int(idx),</span> <span style="color: #F8F8F2">episode_return,</span> <span style="color: #F8F8F2">episode_length))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">stats</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #A6E22E">@torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad()</span></div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_evaluate_vectorized</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">agent:</span> <span style="color: #E6DB74">&quot;Agent&quot;</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">eval_envs:</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">vector</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">VectorEnv,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">device:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">seed:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">42</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line"><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">tuple[np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray]:</span></div>
  <div class="math-annotated-code-line"><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;Vectorized evaluation: runs all episodes in parallel across eval_envs.&quot;&quot;&quot;</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">n_episodes</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">eval_envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">was_training</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">training</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eval()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">obs,</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">eval_envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reset(seed</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">seed)</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">episode_returns</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(n_episodes,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float64)</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">episode_lengths</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(n_episodes,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">int64)</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">final_returns</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">final_lengths</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">done_mask</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(n_episodes,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">bool)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">while</span> <span style="color: #F8F8F2">len(final_returns)</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">n_episodes:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">as_tensor(obs,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get_deterministic_action(obs_t)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs,</span> <span style="color: #F8F8F2">reward,</span> <span style="color: #F8F8F2">terminated,</span> <span style="color: #F8F8F2">truncated,</span> <span style="color: #F8F8F2">infos</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">eval_envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step(action)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">reward_arr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(reward,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float64)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">active_mask</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">~</span><span style="color: #F8F8F2">done_mask</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">episode_returns[active_mask]</span> <span style="color: #FF4689">+=</span> <span style="color: #F8F8F2">reward_arr[active_mask]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">episode_lengths[active_mask]</span> <span style="color: #FF4689">+=</span> <span style="color: #AE81FF">1</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">ep_stats</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">_extract_episode_stats(infos)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">ep_stats_by_env</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">{env_i:</span> <span style="color: #F8F8F2">(ret,</span> <span style="color: #F8F8F2">length)</span> <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">env_i,</span> <span style="color: #F8F8F2">ret,</span> <span style="color: #F8F8F2">length</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">ep_stats}</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">done</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(terminated)</span> <span style="color: #FF4689">|</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(truncated)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(n_episodes):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">done_mask[i]</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">done[i]:</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">ep_stats_by_env:</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">episode_return,</span> <span style="color: #F8F8F2">episode_length</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">ep_stats_by_env[i]</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">final_returns</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(float(episode_return))</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">final_lengths</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(int(episode_length))</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">final_returns</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(float(episode_returns[i]))</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">final_lengths</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(int(episode_lengths[i]))</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">done_mask[i]</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">was_training:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">train()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">array(final_returns),</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">array(final_lengths)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">log_episode_stats</span><span style="color: #F8F8F2">(infos,</span> <span style="color: #F8F8F2">global_step:</span> <span style="color: #F8F8F2">int):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">_,</span> <span style="color: #F8F8F2">episode_return,</span> <span style="color: #F8F8F2">episode_length</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">_extract_episode_stats(infos):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">print(</span><span style="color: #E6DB74">f&quot;global_step={</span><span style="color: #F8F8F2">global_step</span><span style="color: #E6DB74">}, episode_return={</span><span style="color: #F8F8F2">episode_return</span><span style="color: #E6DB74">}&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_wandb(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                <span style="color: #E6DB74">&quot;train/episode_return&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">episode_return,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #E6DB74">&quot;train/episode_length&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">episode_length,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">},</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">step</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">global_step,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">silent</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">layer_init</span><span style="color: #F8F8F2">(layer,</span> <span style="color: #F8F8F2">std</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sqrt(</span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">),</span> <span style="color: #F8F8F2">bias_const</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">orthogonal_(layer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">weight,</span> <span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">constant_(layer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">bias,</span> <span style="color: #F8F8F2">bias_const)</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">layer</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Agent</span><span style="color: #F8F8F2">(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Module):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">super()</span><span style="color: #FF4689">.</span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">len(policy_layer_sizes)</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&quot;policy_layer_sizes must contain at least one layer size&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">len(value_layer_sizes)</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&quot;critic_layer_sizes must contain at least one layer size&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">RunningNorm(obs_dim)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">critic</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_mlp(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">input_dim</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">obs_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">hidden_layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">value_layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">output_dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">output_std</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">actor_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_mlp(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">input_dim</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">obs_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">hidden_layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">policy_layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">output_dim</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">act_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">output_std</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.01</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">actor_logstd</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">act_dim))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #A6E22E">@staticmethod</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_build_mlp</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">input_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">hidden_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">output_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">output_std:</span> <span style="color: #F8F8F2">float,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Sequential:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layers</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">last_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">input_dim</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">hidden_dim</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">hidden_layer_sizes:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">extend([layer_init(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(last_dim,</span> <span style="color: #F8F8F2">hidden_dim)),</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tanh()])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">last_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">hidden_dim</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(layer_init(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(last_dim,</span> <span style="color: #F8F8F2">output_dim),</span> <span style="color: #F8F8F2">std</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">output_std))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Sequential(</span><span style="color: #FF4689">*</span><span style="color: #F8F8F2">layers)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_value</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">x):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">x</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer(x)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">critic(x)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_deterministic_action</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">x):</span></div>
  <div class="math-annotated-code-line"><span style="color: #F8F8F2">        </span><span style="color: #E6DB74">&quot;&quot;&quot;Return mean action after normalizing obs. Used for eval.&quot;&quot;&quot;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">x</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer(x)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">actor_mean(x)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_action_and_value</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">x,</span> <span style="color: #F8F8F2">action</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">None</span><span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">x</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer(x)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">actor_mean(x)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_logstd</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">actor_logstd</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">expand_as(action_mean)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\sigma_{\theta}(s_t) = \exp(\log \sigma_{\theta}(s_t))
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(action_logstd)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">probs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Normal(action_mean,</span> <span style="color: #F8F8F2">action_std)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">action</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">probs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action,</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\log \pi_{\theta}(a_t|s_t) = \sum_j \log \mathcal{N}(a_{t,j}; \mu_{t,j}, \sigma_{t,j})
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">probs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(action)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{H}[\pi_{\theta}(\cdot|s_t)] = \sum_j \mathcal{H}[\mathcal{N}(\mu_{t,j}, \sigma_{t,j})]
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">probs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">entropy()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">critic(x),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">PPOTrainer</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">env_id:</span> <span style="color: #F8F8F2">str,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">seed:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">device:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">critic_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">rollout_steps:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">gamma:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.99</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">gae_lambda:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.95</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">update_epochs:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">10</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">minibatch_size:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">64</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">3e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">clip_ratio:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.2</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">ent_coef:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">vf_coef:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.5</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">max_grad_norm:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.5</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">target_kl:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.02</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">norm_adv:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">clip_vloss:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">anneal_lr:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">num_envs:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">optimizer_type:</span> <span style="color: #F8F8F2">str</span> <span style="color: #FF4689">=</span> <span style="color: #E6DB74">&quot;adam&quot;</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">sgd_momentum:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.9</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">env_id</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">str(env_id)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(seed)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">device</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(num_envs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(rollout_steps)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">batch_size</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">minibatch_size</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(minibatch_size)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(gamma)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gae_lambda</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(gae_lambda)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gae</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">update_epochs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(update_epochs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_coef</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(clip_ratio)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_vloss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">bool(clip_vloss)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">norm_adv</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">bool(norm_adv)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ent_coef</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(ent_coef)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">vf_coef</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(vf_coef)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(max_grad_norm)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target_kl</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">None</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">target_kl</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span> <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">float(target_kl)</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #AE81FF">0.0</span> <span style="color: #66D9EF">else</span> <span style="color: #F8F8F2">float(target_kl)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">anneal_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">bool(anneal_lr)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">learning_rate</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(policy_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">str(optimizer_type)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">strip()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">lower()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sgd_momentum</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(sgd_momentum)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eval_episodes</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">15</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eval_deterministic</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Keep ppo-implementation-details behavior deterministic.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">random</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">random</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">manual_seed(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backends</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cudnn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">deterministic</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">vector</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">SyncVectorEnv(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">[</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">_make_env(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">env_id,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">i,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">isinstance(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">single_action_space,</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">spaces</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Box</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">),</span> <span style="color: #E6DB74">&quot;only continuous action space is supported&quot;</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_shape</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">single_observation_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_shape</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">single_action_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">obs_shape</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&quot;observation space has no shape&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">act_shape</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&quot;action space has no shape&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">array(obs_shape)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">prod())</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">prod(act_shape))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Agent(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_dim</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">obs_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">act_dim</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">act_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">policy_layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">tuple(policy_layer_sizes),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">value_layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">tuple(critic_layer_sizes),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_optimizer()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_build_optimizer</span><span style="color: #F8F8F2">(self)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Optimizer:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">==</span> <span style="color: #E6DB74">&quot;adam&quot;</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Adam(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">lr</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">learning_rate,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">eps</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1e-5</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">==</span> <span style="color: #E6DB74">&quot;sgd&quot;</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">SGD(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">lr</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">learning_rate,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">momentum</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sgd_momentum,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">f&quot;Unsupported PPO optimizer_type &#39;{</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span><span style="color: #E6DB74">}&#39;. &quot;</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;Expected one of: adam, sgd.&quot;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">train</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">total_steps:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">out_dir:</span> <span style="color: #F8F8F2">str,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">total_steps</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(total_steps)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">eval_interval</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">min(</span><span style="color: #AE81FF">5000</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">max(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">total_steps</span> <span style="color: #FF4689">//</span> <span style="color: #AE81FF">150</span><span style="color: #F8F8F2">))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">num_updates</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">total_steps</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">batch_size</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">single_observation_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">single_action_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">logprobs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros((self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">rewards</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros((self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">dones</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros((self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">values</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros((self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">global_step</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">start_time</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">time</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">time()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">next_obs,</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reset()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">next_obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">as_tensor(next_obs,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">next_done</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">last_eval</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">best_eval_score</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(</span><span style="color: #E6DB74">&quot;-inf&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">os</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">makedirs(out_dir,</span> <span style="color: #F8F8F2">exist_ok</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">update</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">num_updates</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">anneal_lr:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
f_u = 1 - \frac{u-1}{U}
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">frac</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">(update</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">num_updates</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
\lambda_u = f_u \lambda_0
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">lrnow</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">frac</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">learning_rate</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">param_groups[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">][</span><span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">lrnow</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">step</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps):</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
t \leftarrow t + N
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">global_step</span> <span style="color: #FF4689">+=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_envs</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">obs[step]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_obs</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">dones[step]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_done</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">action,</span> <span style="color: #F8F8F2">logprob,</span> <span style="color: #F8F8F2">_,</span> <span style="color: #F8F8F2">value</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get_action_and_value(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">next_obs</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">values[step]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">value</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">flatten()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">actions[step]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">action</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">logprobs[step]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">logprob</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_obs_np,</span> <span style="color: #F8F8F2">reward,</span> <span style="color: #F8F8F2">terminated,</span> <span style="color: #F8F8F2">truncated,</span> <span style="color: #F8F8F2">infos</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">action</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
d_t = d_t^{term} \lor d_t^{trunc}
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">done</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">logical_or(terminated,</span> <span style="color: #F8F8F2">truncated)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">rewards[step]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">as_tensor(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">reward,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">view(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">as_tensor(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">next_obs_np,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_done</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">as_tensor(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">done,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">log_episode_stats(infos,</span> <span style="color: #F8F8F2">global_step)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">global_step</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">eval_interval</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">last_eval:</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">last_eval</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">global_step</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">eval_interval</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">eval_envs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">gym</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">vector</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">SyncVectorEnv(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">[</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">_make_env(</span></div>
  <div class="math-annotated-code-line">                                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">env_id,</span></div>
  <div class="math-annotated-code-line">                                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">10_000</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">i,</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eval_episodes)</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">eval_returns,</span> <span style="color: #F8F8F2">eval_lengths</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">_evaluate_vectorized(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent,</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">eval_envs,</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">seed</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">seed</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">10_000</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">metrics</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;eval/return_max&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max(eval_returns)),</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;eval/return_std&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">std(eval_returns)),</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;eval/return_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(eval_returns)),</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;eval/length_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(eval_lengths)),</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;eval/return_min&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">min(eval_returns)),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">}</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">print(</span><span style="color: #E6DB74">f&quot;eval global_step={</span><span style="color: #F8F8F2">global_step</span><span style="color: #E6DB74">}, &quot;</span> <span style="color: #E6DB74">f&quot;{</span><span style="color: #F8F8F2">metrics</span><span style="color: #E6DB74">}&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">log_wandb(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">metrics,</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">step</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">global_step,</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">silent</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">ckpt_payload</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;actor_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">actor_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">state_dict(),</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;actor_logstd&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">actor_logstd</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu(),</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;critic&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">critic</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">state_dict(),</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;optimizer&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">state_dict(),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">}</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">ckpt_last_path</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">os</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">path</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">join(out_dir,</span> <span style="color: #E6DB74">&quot;ppo_last.pt&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">save(ckpt_payload,</span> <span style="color: #F8F8F2">ckpt_last_path)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">print(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">f&quot;[PPO][checkpoint] step={</span><span style="color: #F8F8F2">global_step</span><span style="color: #E6DB74">}/{</span><span style="color: #F8F8F2">total_steps</span><span style="color: #E6DB74">}: &quot;</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">f&quot;saved {</span><span style="color: #F8F8F2">ckpt_last_path</span><span style="color: #E6DB74">}&quot;</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">eval_score</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(metrics[</span><span style="color: #E6DB74">&quot;eval/return_mean&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">eval_score</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">best_eval_score:</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">best_eval_score</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">eval_score</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">ckpt_best_path</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">os</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">path</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">join(out_dir,</span> <span style="color: #E6DB74">&quot;ppo_best.pt&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">save(ckpt_payload,</span> <span style="color: #F8F8F2">ckpt_best_path)</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">print(</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #E6DB74">f&quot;[PPO][checkpoint-best] step={</span><span style="color: #F8F8F2">global_step</span><span style="color: #E6DB74">}/{</span><span style="color: #F8F8F2">total_steps</span><span style="color: #E6DB74">}: &quot;</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #E6DB74">f&quot;score={</span><span style="color: #F8F8F2">eval_score</span><span style="color: #E6DB74">:.6f}, saved {</span><span style="color: #F8F8F2">ckpt_best_path</span><span style="color: #E6DB74">}&quot;</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_value</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get_value(next_obs)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gae:</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros_like(rewards,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">lastgaelam</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">reversed(range(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps)):</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 28ch;">
    <div class="arithmatex">\[
m_{t+1} = 1 - d_{t+1}
\]</div>
  </div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">nextnonterminal</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">next_done</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">nextvalues</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_value</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 28ch;">
    <div class="arithmatex">\[
m_{t+1} = 1 - d_{t+1}
\]</div>
  </div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">nextnonterminal</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">dones[t</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">nextvalues</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">values[t</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\delta_t = r_t + \gamma V(s_{t+1}) m_{t+1} - V(s_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">delta</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">rewards[t]</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">nextvalues</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">nextnonterminal</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">values[t]</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
A_t = \delta_t + \gamma \lambda m_{t+1} A_{t+1}
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">advantages[t]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">lastgaelam</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">delta</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gae_lambda</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">nextnonterminal</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">lastgaelam</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
R_t = A_t + V(s_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">returns</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">advantages</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">values</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">returns</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros_like(rewards,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">reversed(range(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps)):</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">num_steps</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 28ch;">
    <div class="arithmatex">\[
m_{t+1} = 1 - d_{t+1}
\]</div>
  </div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">nextnonterminal</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">next_done</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">next_return</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_value</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 28ch;">
    <div class="arithmatex">\[
m_{t+1} = 1 - d_{t+1}
\]</div>
  </div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">nextnonterminal</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">dones[t</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">next_return</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">returns[t</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
R_t = r_t + \gamma m_{t+1} R_{t+1}
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">returns[t]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">rewards[t]</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">nextnonterminal</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">next_return</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
A_t = R_t - V(s_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">returns</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">values</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">b_obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape((</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">single_observation_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">b_logprobs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">logprobs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">b_actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape((</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">single_action_space</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">b_advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">b_returns</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">returns</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">b_values</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">values</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">b_inds</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">arange(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">batch_size)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">clipfracs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Track last minibatch values for logging parity with reference implementation.</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">pg_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">v_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">entropy_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">old_approx_kl</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">approx_kl</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">update_epochs):</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">random</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shuffle(b_inds)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">start</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">batch_size,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">minibatch_size):</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">end</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">start</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">minibatch_size</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">mb_inds</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">b_inds[start:end]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">_,</span> <span style="color: #F8F8F2">newlogprob,</span> <span style="color: #F8F8F2">entropy,</span> <span style="color: #F8F8F2">newvalue</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get_action_and_value(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">b_obs[mb_inds],</span> <span style="color: #F8F8F2">b_actions[mb_inds]</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
\log r_t = \log \pi_{\theta}(a_t|s_t) - \log \pi_{\theta_{old}}(a_t|s_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">logratio</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">newlogprob</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">b_logprobs[mb_inds]</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
r_t = \exp(\log r_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">ratio</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">logratio</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #959077"># calculate approx_kl http://joschu.net/blog/kl-approx.html</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\widehat{D}_{KL}^{old} \approx \mathbb{E}[-\log r_t]
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">old_approx_kl</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span><span style="color: #FF4689">-</span><span style="color: #F8F8F2">logratio)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\widehat{D}_{KL} \approx \mathbb{E}[r_t - 1 - \log r_t]
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">approx_kl</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">((ratio</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">logratio)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">clipfracs</span> <span style="color: #FF4689">+=</span> <span style="color: #F8F8F2">[</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">((ratio</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">abs()</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_coef)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">mb_advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">b_advantages[mb_inds]</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">norm_adv:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\hat{A}_t = \frac{A_t - \mu_A}{\sigma_A + \epsilon}
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">mb_advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(mb_advantages</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">mb_advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean())</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">mb_advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">std()</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
\mathcal{L}_{pg}^{(1)} = -\hat{A}_t r_t
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">pg_loss1</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">mb_advantages</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">ratio</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
\mathcal{L}_{pg}^{(2)} = -\hat{A}_t \operatorname{clip}(r_t, 1-\epsilon, 1+\epsilon)
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">pg_loss2</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">mb_advantages</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">ratio,</span> <span style="color: #AE81FF">1</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_coef,</span> <span style="color: #AE81FF">1</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_coef</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
\mathcal{L}_{pg} = \mathbb{E}\left[\max\left(\mathcal{L}_{pg}^{(1)}, \mathcal{L}_{pg}^{(2)}\right)\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">pg_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max(pg_loss1,</span> <span style="color: #F8F8F2">pg_loss2)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">newvalue</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">newvalue</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">view(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_vloss:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\mathcal{L}_{V}^{unclip} = (V_{\theta}(s_t)-R_t)^2
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">v_loss_unclipped</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(newvalue</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">b_returns[mb_inds])</span> <span style="color: #FF4689">**</span> <span style="color: #AE81FF">2</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
V_{\theta}^{clip}(s_t) = V_{\theta_{old}}(s_t) + \operatorname{clip}(V_{\theta}(s_t)-V_{\theta_{old}}(s_t), -\epsilon, \epsilon)
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">v_clipped</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">b_values[mb_inds]</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">newvalue</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">b_values[mb_inds],</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #FF4689">-</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_coef,</span></div>
  <div class="math-annotated-code-line">                            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_coef,</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\mathcal{L}_{V}^{clip} = (V_{\theta}^{clip}(s_t)-R_t)^2
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">v_loss_clipped</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(v_clipped</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">b_returns[mb_inds])</span> <span style="color: #FF4689">**</span> <span style="color: #AE81FF">2</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">v_loss_max</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max(v_loss_unclipped,</span> <span style="color: #F8F8F2">v_loss_clipped)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\mathcal{L}_{V} = \frac{1}{2}\mathbb{E}\left[\max(\mathcal{L}_{V}^{unclip}, \mathcal{L}_{V}^{clip})\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">v_loss</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.5</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">v_loss_max</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 24ch;">
    <div class="arithmatex">\[
\mathcal{L}_{V} = \frac{1}{2}\mathbb{E}\left[(V_{\theta}(s_t)-R_t)^2\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">v_loss</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.5</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">((newvalue</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">b_returns[mb_inds])</span> <span style="color: #FF4689">**</span> <span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">entropy_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">entropy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
\mathcal{L} = \mathcal{L}_{pg} - c_H \mathcal{H} + c_V \mathcal{L}_{V}
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">pg_loss</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ent_coef</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">entropy_loss</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">v_loss</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">vf_coef</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zero_grad()</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backward()</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_grad_norm_(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">agent</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target_kl</span> <span style="color: #FF4689">is</span> <span style="color: #FF4689">not</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">approx_kl</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target_kl:</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #66D9EF">break</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">y_pred,</span> <span style="color: #F8F8F2">y_true</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">b_values</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy(),</span> <span style="color: #F8F8F2">b_returns</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">var_y</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">var(y_true)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\operatorname{EV} = 1 - \frac{\operatorname{Var}[R - V]}{\operatorname{Var}[R]}
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">explained_var</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">nan</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">var_y</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span> <span style="color: #66D9EF">else</span> <span style="color: #AE81FF">1</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">var(y_true</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">y_pred)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">var_y</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">sps</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(global_step</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">max(time</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">time()</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">start_time,</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">))</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_wandb(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;charts/learning_rate&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">param_groups[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">][</span><span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;losses/value_loss&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">v_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item(),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;losses/policy_loss&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">pg_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item(),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;losses/entropy&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">entropy_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item(),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;losses/old_approx_kl&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">old_approx_kl</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item(),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;losses/approx_kl&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">approx_kl</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item(),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;losses/clipfrac&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(clipfracs))</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">clipfracs</span> <span style="color: #66D9EF">else</span> <span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;losses/explained_variance&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(explained_var),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;charts/SPS&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(sps),</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">},</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">step</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">global_step,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">silent</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">print(</span><span style="color: #E6DB74">&quot;SPS:&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">sps)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">envs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">close()</span></div>
</div>
