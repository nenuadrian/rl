# `trainers.mpo.agent` Math-Annotated Source

_Source: `minerva/trainers/mpo/agent.py`_

The full file is rendered in one continuous code-style block, with each `# LaTeX:` marker replaced inline by a rendered formula.

## Annotated Source

<div class="math-annotated-codeblock">
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> __future__ </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">annotations</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> copy</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> math</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> typing </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">Tuple</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> numpy </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> np</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch.nn </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> nn</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch.nn.functional </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> F</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> torch.distributions </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">Normal</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">LayerNormMLP</span><span style="color: #F8F8F2">(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Module):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">in_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">activate_final:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">super()</span><span style="color: #FF4689">.</span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layers</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># First layer: Linear → LayerNorm → tanh</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(in_dim,</span> <span style="color: #F8F8F2">layer_sizes[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">]))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">LayerNorm(layer_sizes[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">]))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tanh())</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Remaining layers: ELU</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">len(layer_sizes)):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(layer_sizes[i</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">],</span> <span style="color: #F8F8F2">layer_sizes[i]))</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">activate_final</span> <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">len(layer_sizes)</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">append(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ELU())</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">net</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Sequential(</span><span style="color: #FF4689">*</span><span style="color: #F8F8F2">layers)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">forward</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">x:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">net(x)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">SmallInitLinear</span><span style="color: #F8F8F2">(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">in_features:</span> <span style="color: #F8F8F2">int,</span> <span style="color: #F8F8F2">out_features:</span> <span style="color: #F8F8F2">int,</span> <span style="color: #F8F8F2">std:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.01</span><span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">super()</span><span style="color: #FF4689">.</span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(in_features,</span> <span style="color: #F8F8F2">out_features)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">trunc_normal_(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">weight,</span> <span style="color: #F8F8F2">std</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros_(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">bias)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Critic</span><span style="color: #F8F8F2">(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Module):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_low:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_high:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">super()</span><span style="color: #FF4689">.</span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_low:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_high:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">register_buffer(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;action_low&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(action_low,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">register_buffer(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;action_high&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(action_high,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">encoder</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">LayerNormMLP(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_dim</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">act_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">activate_final</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Acme uses a small-init linear head for nondistributional critics.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">head</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">SmallInitLinear(layer_sizes[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">],</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">std</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.01</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">forward</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">act:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">maximum(torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">minimum(act,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_high),</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_low)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">x</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cat([obs,</span> <span style="color: #F8F8F2">act],</span> <span style="color: #F8F8F2">dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">head(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">encoder(x))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">DiagonalGaussianPolicy</span><span style="color: #F8F8F2">(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Module):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_low:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray</span> <span style="color: #FF4689">|</span> <span style="color: #66D9EF">None</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_high:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray</span> <span style="color: #FF4689">|</span> <span style="color: #66D9EF">None</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">super()</span><span style="color: #FF4689">.</span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">encoder</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">LayerNormMLP(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">activate_final</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(layer_sizes[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">],</span> <span style="color: #F8F8F2">act_dim)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(layer_sizes[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">],</span> <span style="color: #F8F8F2">act_dim)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">kaiming_normal_(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">weight,</span> <span style="color: #F8F8F2">a</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">mode</span><span style="color: #FF4689">=</span><span style="color: #E6DB74">&quot;fan_in&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">nonlinearity</span><span style="color: #FF4689">=</span><span style="color: #E6DB74">&quot;linear&quot;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros_(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">bias)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">action_low</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span> <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">action_high</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_low</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones(act_dim,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_high</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones(act_dim,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_low_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(action_low,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_high_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(action_high,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_low:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_high:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">register_buffer(</span><span style="color: #E6DB74">&quot;action_low&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">action_low_t)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">register_buffer(</span><span style="color: #E6DB74">&quot;action_high&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">action_high_t)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">forward</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">h</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">encoder(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">forward_with_features(h)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">forward_with_features</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">features:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">h</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">features</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean(h)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd(h)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">nan_to_num(mean,</span> <span style="color: #F8F8F2">nan</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">posinf</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">neginf</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">nan_to_num(log_std,</span> <span style="color: #F8F8F2">nan</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">posinf</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">neginf</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(log_std,</span> <span style="color: #FF4689">-</span><span style="color: #AE81FF">20.0</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">2.0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">log_prob</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">mean:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">log_std:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">actions_raw:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(log_std,</span> <span style="color: #FF4689">-</span><span style="color: #AE81FF">20.0</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">2.0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">normal</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Normal(mean,</span> <span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_prob</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">normal</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(actions_raw)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">log_prob</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">keepdim</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_clip_to_env_bounds</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">actions_raw:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">maximum(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">minimum(actions_raw,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_high),</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_low</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">sample_action_raw_and_exec</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">deterministic:</span> <span style="color: #F8F8F2">bool,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #FF4689">**</span><span style="color: #F8F8F2">kwargs,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(log_std,</span> <span style="color: #FF4689">-</span><span style="color: #AE81FF">20.0</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">2.0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">deterministic:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions_raw</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">mean</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">normal</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Normal(mean,</span> <span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions_raw</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">normal</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">rsample()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions_exec</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_clip_to_env_bounds(actions_raw)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">actions_raw,</span> <span style="color: #F8F8F2">actions_exec</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">sample_action</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">mean:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">log_std:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">deterministic:</span> <span style="color: #F8F8F2">bool,</span> <span style="color: #FF4689">**</span><span style="color: #F8F8F2">kwargs</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">_,</span> <span style="color: #F8F8F2">actions_exec</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_action_raw_and_exec(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std,</span> <span style="color: #F8F8F2">deterministic,</span> <span style="color: #FF4689">**</span><span style="color: #F8F8F2">kwargs</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">actions_exec</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">sample_actions_raw_and_exec</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">num_actions:</span> <span style="color: #F8F8F2">int</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">forward(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(log_std,</span> <span style="color: #FF4689">-</span><span style="color: #AE81FF">20.0</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">2.0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">normal</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Normal(mean,</span> <span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions_raw</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">normal</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">rsample(sample_shape</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">(num_actions,))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions_raw</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions_raw</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">permute(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions_exec</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_clip_to_env_bounds(actions_raw)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">actions_raw,</span> <span style="color: #F8F8F2">actions_exec</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">sample_actions</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">num_actions:</span> <span style="color: #F8F8F2">int)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">_,</span> <span style="color: #F8F8F2">actions_exec</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_actions_raw_and_exec(obs,</span> <span style="color: #F8F8F2">num_actions)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">actions_exec</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">head_parameters</span><span style="color: #F8F8F2">(self):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">list(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">list(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">MPOAgent</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_low:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_high:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">device:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">critic_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">gamma:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.99</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">target_networks_update_period:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">100</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">3e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">3e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">kl_epsilon:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.1</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mstep_kl_epsilon:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.1</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_init:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">3e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">lambda_init:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">lambda_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">3e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">epsilon_penalty:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.001</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">max_grad_norm:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_samples:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">20</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">use_retrace:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">retrace_steps:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">2</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">retrace_mc_actions:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">8</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">retrace_lambda:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.95</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">optimizer_type:</span> <span style="color: #F8F8F2">str</span> <span style="color: #FF4689">=</span> <span style="color: #E6DB74">&quot;adam&quot;</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">sgd_momentum:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.9</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">init_log_alpha_mean:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">10.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">init_log_alpha_stddev:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1000.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">m_steps:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">device</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(gamma)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target_networks_update_period</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(target_networks_update_period)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(policy_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(q_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">kl_epsilon</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(kl_epsilon)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mstep_kl_epsilon</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(mstep_kl_epsilon)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_init</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(temperature_init)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(temperature_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">lambda_init</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(lambda_init)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">lambda_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(lambda_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_penalty</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(epsilon_penalty)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(max_grad_norm)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_samples</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(action_samples)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">use_retrace</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">bool(use_retrace)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_steps</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(retrace_steps)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_mc_actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(retrace_mc_actions)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_lambda</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(retrace_lambda)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">str(optimizer_type)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sgd_momentum</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(sgd_momentum)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">m_steps</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(m_steps)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Learner step counter for periodic target synchronization.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_num_steps</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_skipped_nonfinite_batches</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">DiagonalGaussianPolicy(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">act_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">policy_layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_low</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">action_low,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_high</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">action_high,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">copy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">deepcopy(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eval()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Single critic using the Acme control-network critic torso.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Critic(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">act_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">critic_layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_low</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">action_low,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_high</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">action_high,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">print(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">print(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">copy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">deepcopy(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eval()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Train policy encoder + head together; critics share a separate encoder.</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\tilde{\lambda}_{\pi} = \frac{\lambda_{\pi}}{\max(1, M)}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_lr_effective</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_lr)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">max(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">int(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">m_steps))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_opt</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_optimizer(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span> <span style="color: #F8F8F2">lr</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">policy_lr_effective</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Critic optimizer.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_opt</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_optimizer(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span> <span style="color: #F8F8F2">lr</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_lr)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Dual variables (temperature + KL multipliers) in log-space.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_init,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">lambda_init_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">lambda_init,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">lambda_init_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(lambda_init_t,</span> <span style="color: #F8F8F2">min</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">dual_shape</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(act_dim,)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">full(dual_shape,</span> <span style="color: #F8F8F2">init_log_alpha_mean,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_stddev</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">full(dual_shape,</span> <span style="color: #F8F8F2">init_log_alpha_stddev,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Dual optimizer uses separate LRs for temperature vs alphas.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_params</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">alpha_params</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mean,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_stddev]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">dual_opt</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_optimizer(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">[</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span><span style="color: #E6DB74">&quot;params&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">temperature_params,</span> <span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_lr},</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span><span style="color: #E6DB74">&quot;params&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">alpha_params,</span> <span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">lambda_lr},</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_build_optimizer</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">params,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">|</span> <span style="color: #66D9EF">None</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Optimizer:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">strip()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">lower()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">kwargs:</span> <span style="color: #F8F8F2">dict[str,</span> <span style="color: #F8F8F2">float]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">{}</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">lr</span> <span style="color: #FF4689">is</span> <span style="color: #FF4689">not</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kwargs[</span><span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(lr)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">==</span> <span style="color: #E6DB74">&quot;sgd&quot;</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kwargs[</span><span style="color: #E6DB74">&quot;momentum&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sgd_momentum)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">SGD(params,</span> <span style="color: #FF4689">**</span><span style="color: #F8F8F2">kwargs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kwargs[</span><span style="color: #E6DB74">&quot;eps&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1e-5</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Adam(params,</span> <span style="color: #FF4689">**</span><span style="color: #F8F8F2">kwargs)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_kl_diag_gaussian_per_dim</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_p,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std_p,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_q,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std_q,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">inv_var_q</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">2.0</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">log_std_q)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">var_ratio</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(</span><span style="color: #AE81FF">2.0</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(log_std_p</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">log_std_q))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #AE81FF">0.5</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(var_ratio</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(mean_p</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">mean_q)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">pow(</span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">inv_var_q</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_std_q</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">log_std_p</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_compute_weights_and_temperature_loss</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q_values:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">epsilon:</span> <span style="color: #F8F8F2">float,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #E6DB74">&quot;&quot;&quot;Acme-style E-step weights and dual temperature loss.</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q_values</span> <span style="color: #F8F8F2">shape</span> <span style="color: #F8F8F2">(B,N)</span><span style="color: #FF4689">.</span> <span style="color: #F8F8F2">Returns</span> <span style="color: #F8F8F2">weights</span> <span style="color: #F8F8F2">(B,N)</span> <span style="color: #F8F8F2">detached</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">loss</span> <span style="color: #F8F8F2">scalar</span><span style="color: #FF4689">.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #E6DB74">&quot;&quot;&quot;</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\bar{Q}_{b,i} = \frac{Q_{b,i}}{\eta}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q_detached</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">q_values</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">temperature</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
q_{b,i} = \frac{\exp(\bar{Q}_{b,i})}{\sum_j \exp(\bar{Q}_{b,j})}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softmax(q_detached,</span> <span style="color: #F8F8F2">dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\log Z_b = \log \sum_i \exp(\bar{Q}_{b,i})
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q_logsumexp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">logsumexp(q_detached,</span> <span style="color: #F8F8F2">dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_num_actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">math</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log(q_values</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\eta} = \eta\left(\epsilon + \frac{1}{B}\sum_b \log Z_b - \log N\right)
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_temperature</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">temperature</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">float(epsilon)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">q_logsumexp</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">log_num_actions</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">weights,</span> <span style="color: #F8F8F2">loss_temperature</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_compute_nonparametric_kl_from_weights</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">weights:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #E6DB74">&quot;&quot;&quot;Estimates KL(nonparametric || target) like Acme&#39;s diagnostics.</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">weights</span> <span style="color: #F8F8F2">shape</span> <span style="color: #F8F8F2">(B,N)</span><span style="color: #FF4689">.</span> <span style="color: #F8F8F2">Returns</span> <span style="color: #F8F8F2">(B,)</span> <span style="color: #F8F8F2">KL</span><span style="color: #FF4689">.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #E6DB74">&quot;&quot;&quot;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">n</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\ell_{b,i} = \log\!\left(N q_{b,i}\right)
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">integrand</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log(n</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">weights</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
D_{KL}(q_b\|u) = \sum_i q_{b,i}\log\!\left(N q_{b,i}\right)
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">(weights</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">integrand)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_to_device_tensor</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">value:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray</span> <span style="color: #FF4689">|</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line"><span style="color: #F8F8F2">        </span><span style="color: #E6DB74">&quot;&quot;&quot;Fast path for float32 host arrays -&gt; device tensors.&quot;&quot;&quot;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">isinstance(value,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">value</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">non_blocking</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">arr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(value,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">arr</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">flags</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">c_contiguous:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">arr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ascontiguousarray(arr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">from_numpy(arr)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span> <span style="color: #F8F8F2">non_blocking</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_assert_finite_tensors</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">tensors:</span> <span style="color: #F8F8F2">dict[str,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor])</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">try</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">name,</span> <span style="color: #F8F8F2">tensor</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">tensors</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">items():</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">bool(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">isfinite(tensor)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">all()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">),</span> <span style="color: #E6DB74">f&quot;non-finite values in &#39;{</span><span style="color: #F8F8F2">name</span><span style="color: #E6DB74">}&#39;&quot;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">except</span> <span style="color: #A6E22E">AssertionError</span> <span style="color: #66D9EF">as</span> <span style="color: #F8F8F2">exc:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_skipped_nonfinite_batches</span> <span style="color: #FF4689">+=</span> <span style="color: #AE81FF">1</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_skipped_nonfinite_batches</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #AE81FF">5</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_skipped_nonfinite_batches</span> <span style="color: #FF4689">%</span> <span style="color: #AE81FF">100</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">print(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;[MPO][warn] &quot;</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">f&quot;{</span><span style="color: #F8F8F2">exc</span><span style="color: #E6DB74">}; skipped batch #{</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_skipped_nonfinite_batches</span><span style="color: #E6DB74">}&quot;</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">False</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">act_with_logp</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">deterministic:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">tuple[np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">float]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(obs)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">inference_mode():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy(obs_t)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_raw,</span> <span style="color: #F8F8F2">action_exec</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_action_raw_and_exec(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std,</span> <span style="color: #F8F8F2">deterministic</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">logp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(mean,</span> <span style="color: #F8F8F2">log_std,</span> <span style="color: #F8F8F2">action_raw)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_exec</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_raw</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">float(logp</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">act</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">deterministic:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_exec,</span> <span style="color: #F8F8F2">_,</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">act_with_logp(obs,</span> <span style="color: #F8F8F2">deterministic</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">deterministic)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">action_exec</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_expected_q_current</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_actions(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">obs,</span> <span style="color: #F8F8F2">num_actions</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_mc_actions</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">batch_size</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_rep</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">expand(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">batch_size,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_mc_actions,</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_rep</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">act_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">actions</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">q</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_target(obs_flat,</span> <span style="color: #F8F8F2">act_flat)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">q</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_mc_actions)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">keepdim</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_retrace_q_target</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">batch:</span> <span style="color: #F8F8F2">dict)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions_exec_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;actions_exec&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions_raw_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;actions_raw&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">rewards_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;rewards&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">next_obs_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;next_obs&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">dones_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;dones&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">behaviour_logp_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;behaviour_logp&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">batch_size,</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #F8F8F2">obs_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_seq</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions_exec_seq</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_seq</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #F8F8F2">obs_dim)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">act_exec_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions_exec_seq</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #F8F8F2">act_dim)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">q_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_target(obs_flat,</span> <span style="color: #F8F8F2">act_exec_flat)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size,</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">next_obs_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_obs_seq</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #F8F8F2">obs_dim)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">v_next</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_expected_q_current(next_obs_flat)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">batch_size,</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #AE81FF">1</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\delta_t = r_t + \gamma(1-d_t)V(s_{t+1}) - Q(s_t,a_t)
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">delta</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">rewards_seq</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">dones_seq)</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">v_next</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">q_t</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target(obs_flat)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions_raw_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions_raw_seq</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #F8F8F2">act_dim)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_pi</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std,</span> <span style="color: #F8F8F2">actions_raw_flat</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size,</span> <span style="color: #F8F8F2">seq_len,</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_b</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">behaviour_logp_seq</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\log \rho_t = \log \pi(a_t|s_t) - \log b(a_t|s_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_ratio</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_pi</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">log_b</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\rho_t = \exp(\log \rho_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">rho</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(log_ratio)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
c_t = \lambda \min(1, \rho_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">c</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_lambda</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">minimum(torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones_like(rho),</span> <span style="color: #F8F8F2">rho))</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Correct Retrace recursion:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Qret(s0,a0) = Q(s0,a0) + sum_{t=0}^{T-1} gamma^t (prod_{i=1}^t c_i) delta_t</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
Q^{ret} \leftarrow Q(s_0, a_0)
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">q_ret</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">q_t[:,</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">:]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clone()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">cont</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones((batch_size,</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">c_prod</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones((batch_size,</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">discount</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones((batch_size,</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">dones_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">dones_seq</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (B,T)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(seq_len):</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">&gt;</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
m_t \leftarrow m_{t-1}(1-d_{t-1})
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">cont</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">cont</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">dones_flat[:,</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1</span> <span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">t])</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
C_t \leftarrow C_{t-1} c_t
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">c_prod</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">c_prod</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">c[:,</span> <span style="color: #F8F8F2">t</span> <span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">t</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 20ch;">
    <div class="arithmatex">\[
\Gamma_t \leftarrow \Gamma_{t-1}\gamma
\]</div>
  </div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">discount</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">discount</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
Q^{ret} \leftarrow Q^{ret} + m_t \Gamma_t C_t \delta_t
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">q_ret</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">q_ret</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">cont</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">discount</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">c_prod</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">delta[:,</span> <span style="color: #F8F8F2">t,</span> <span style="color: #F8F8F2">:]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">q_ret</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">update</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">batch:</span> <span style="color: #F8F8F2">dict)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">dict</span> <span style="color: #FF4689">|</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_num_steps</span> <span style="color: #FF4689">%</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target_networks_update_period</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">load_state_dict(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">state_dict())</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">load_state_dict(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">state_dict())</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_batch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get(</span><span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">is_sequence_batch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">isinstance(obs_batch,</span> <span style="color: #F8F8F2">(np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor))</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_batch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndim</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">3</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">use_retrace</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">use_retrace</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">use_retrace</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">is_sequence_batch</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">retrace_steps</span> <span style="color: #FF4689">&gt;</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions_exec_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;actions_exec&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions_raw_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;actions_raw&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">rewards_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;rewards&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">next_obs_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;next_obs&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">dones_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;dones&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">behaviour_logp_seq</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;behaviour_logp&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_assert_finite_tensors(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">obs_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;actions_exec&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">actions_exec_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;actions_raw&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">actions_raw_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;rewards&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">rewards_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;next_obs&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">next_obs_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;dones&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">dones_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;behaviour_logp&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">behaviour_logp_seq,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">}</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">None</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_retrace_q_target(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">obs_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;actions_exec&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">actions_exec_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;actions_raw&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">actions_raw_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;rewards&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">rewards_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;next_obs&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">next_obs_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;dones&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">dones_seq,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;behaviour_logp&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">behaviour_logp_seq,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">}</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_seq[:,</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">:]</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions_exec_seq[:,</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">:]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions_key</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #E6DB74">&quot;actions_exec&quot;</span> <span style="color: #66D9EF">if</span> <span style="color: #E6DB74">&quot;actions_exec&quot;</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">batch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">keys()</span> <span style="color: #66D9EF">else</span> <span style="color: #E6DB74">&quot;actions&quot;</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[actions_key])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">rewards</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;rewards&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">next_obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;next_obs&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">dones</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_to_device_tensor(batch[</span><span style="color: #E6DB74">&quot;dones&quot;</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_assert_finite_tensors(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">obs,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;actions&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">actions,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;rewards&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">rewards,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;next_obs&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">next_obs,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;dones&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">dones,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">}</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">None</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_actions(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">next_obs,</span> <span style="color: #F8F8F2">num_actions</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_samples</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">batch_size</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_obs_rep</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">expand(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">batch_size,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_samples,</span> <span style="color: #F8F8F2">next_obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_obs_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_obs_rep</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">next_obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">next_act_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">next_actions</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">next_actions</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">q_target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_target(next_obs_flat,</span> <span style="color: #F8F8F2">next_act_flat)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">q_target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">q_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(batch_size,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_samples)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">keepdim</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
y_t = r_t + \gamma(1-d_t)\bar{Q}(s_{t+1})
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">rewards</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">dones)</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">q_target</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_assert_finite_tensors(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">{</span><span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">obs,</span> <span style="color: #E6DB74">&quot;actions&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">actions,</span> <span style="color: #E6DB74">&quot;target&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">target}</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">None</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q(obs,</span> <span style="color: #F8F8F2">actions)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_Q = \mathbb{E}\!\left[(Q(s_t,a_t) - y_t)^2\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mse_loss(q,</span> <span style="color: #F8F8F2">target)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_assert_finite_tensors({</span><span style="color: #E6DB74">&quot;q&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">q,</span> <span style="color: #E6DB74">&quot;q_loss&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">q_loss}):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">None</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Phase A: critic update</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zero_grad()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">q_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backward()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_grad_norm_(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Phase B (Acme-style): update dual vars then do policy M-step.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">batch_size</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">num_samples</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">action_samples</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_online,</span> <span style="color: #F8F8F2">log_std_online</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_target,</span> <span style="color: #F8F8F2">log_std_target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target(obs)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">sampled_actions_raw,</span> <span style="color: #F8F8F2">sampled_actions_exec</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_actions_raw_and_exec(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">obs,</span> <span style="color: #F8F8F2">num_actions</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">num_samples</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (B,N,D)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_rep</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">expand(batch_size,</span> <span style="color: #F8F8F2">num_samples,</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_rep</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">obs</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">act_exec_flat</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">sampled_actions_exec</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">sampled_actions_exec</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">q_vals</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">q_target(obs_flat,</span> <span style="color: #F8F8F2">act_exec_flat)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">reshape(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">batch_size,</span> <span style="color: #F8F8F2">num_samples</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_assert_finite_tensors({</span><span style="color: #E6DB74">&quot;q_vals&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">q_vals}):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">None</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">min_log</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">18.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_temp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">maximum(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature,</span> <span style="color: #F8F8F2">min_log)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\eta = \operatorname{softplus}(\tilde{\eta}) + \epsilon
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(log_temp)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">weights,</span> <span style="color: #F8F8F2">loss_temperature</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_compute_weights_and_temperature_loss(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">q_vals,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">kl_epsilon,</span> <span style="color: #F8F8F2">temperature</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># KL(nonparametric || target) diagnostic (relative).</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">kl_nonparametric</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_compute_nonparametric_kl_from_weights(weights)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathrm{KL}_{rel} = \frac{\mathbb{E}[D_{KL}(q\|u)]}{\epsilon}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">kl_q_rel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">kl_nonparametric</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">float(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">kl_epsilon)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Compute Acme-style decomposed losses.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std_online</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(log_std_online)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std_target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(log_std_target)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Fixed distributions for decomposition.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">sampled_actions_raw</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span>  <span style="color: #959077"># (B,N,D), stop-gradient wrt sampling.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_online_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">mean_online</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std_online_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">std_online</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_target_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">mean_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std_target_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">std_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># fixed_stddev: mean=online_mean, std=target_std</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_prob_fixed_stddev</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">Normal(mean_online_exp,</span> <span style="color: #F8F8F2">std_target_exp)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(actions)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># fixed_mean: mean=target_mean, std=online_std</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_prob_fixed_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">Normal(mean_target_exp,</span> <span style="color: #F8F8F2">std_online_exp)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(actions)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Cross entropy / weighted log-prob.</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\pi,\mu} = -\mathbb{E}_b\sum_i q_{b,i}\log \pi_{\mu,\sigma&#x27;}(a_{b,i}|s_b)
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_policy_mean</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">(weights</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">log_prob_fixed_stddev)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\pi,\sigma} = -\mathbb{E}_b\sum_i q_{b,i}\log \pi_{\mu&#x27;,\sigma}(a_{b,i}|s_b)
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_policy_std</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">(weights</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">log_prob_fixed_mean)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\pi} = \mathcal{L}_{\pi,\mu} + \mathcal{L}_{\pi,\sigma}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_policy</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">loss_policy_mean</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">loss_policy_std</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">kl_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_kl_diag_gaussian_per_dim(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach(),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_std_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach(),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_online,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_std_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach(),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (B,D)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">kl_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_kl_diag_gaussian_per_dim(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach(),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_std_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach(),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach(),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_std_online,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (B,D)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\bar{D}_{\mu,j} = \frac{1}{B}\sum_b D_{\mu,b,j}
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_kl_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">kl_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\bar{D}_{\sigma,j} = \frac{1}{B}\sum_b D_{\sigma,b,j}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_kl_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">kl_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_alpha_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">maximum(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mean,</span> <span style="color: #F8F8F2">min_log)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_alpha_stddev</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">maximum(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_stddev,</span> <span style="color: #F8F8F2">min_log)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\alpha_{\mu,j} = \operatorname{softplus}(\tilde{\alpha}_{\mu,j}) + \epsilon
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">alpha_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(log_alpha_mean)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\alpha_{\sigma,j} = \operatorname{softplus}(\tilde{\alpha}_{\sigma,j}) + \epsilon
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">alpha_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(log_alpha_stddev)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{KL,\mu} = \sum_j \alpha_{\mu,j}\bar{D}_{\mu,j}
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_kl_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(alpha_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">mean_kl_mean)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{KL,\sigma} = \sum_j \alpha_{\sigma,j}\bar{D}_{\sigma,j}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_kl_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(alpha_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">mean_kl_std)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{KL} = \mathcal{L}_{KL,\mu} + \mathcal{L}_{KL,\sigma}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_kl_penalty</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">loss_kl_mean</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">loss_kl_std</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_alpha_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">alpha_mean</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mstep_kl_epsilon</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">mean_kl_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach())</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\alpha_{\mu}} = \sum_j \alpha_{\mu,j}(\epsilon_{KL} - \bar{D}_{\mu,j})
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">loss_alpha_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">alpha_std</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mstep_kl_epsilon</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">mean_kl_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach())</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\alpha_{\sigma}} = \sum_j \alpha_{\sigma,j}(\epsilon_{KL} - \bar{D}_{\sigma,j})
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Update dual variables (temperature + alphas).</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{dual} = \mathcal{L}_{\eta} + \mathcal{L}_{\alpha_{\mu}} + \mathcal{L}_{\alpha_{\sigma}}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">dual_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">loss_temperature</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">loss_alpha_mean</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">loss_alpha_std</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">dual_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zero_grad()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">dual_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backward()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_grad_norm_(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">[</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">p</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">p</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">[</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mean,</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_stddev,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">p</span> <span style="color: #FF4689">is</span> <span style="color: #FF4689">not</span> <span style="color: #66D9EF">None</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">dual_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># ---------- after dual_opt.step() ----------</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Recompute the post-update dual multipliers and freeze fixed E-step tensors.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_target_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">mean_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_std_target_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">std_target_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">std_target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">weights_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span>  <span style="color: #959077"># (B,N)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">actions_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">actions</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span>  <span style="color: #959077"># (B,N,D)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Recompute dual multipliers AFTER dual_opt.step()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\alpha_{\mu,j}&#x27; = \operatorname{softplus}(\tilde{\alpha}_{\mu,j}) + \epsilon
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">alpha_mean_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mean)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\alpha_{\sigma,j}&#x27; = \operatorname{softplus}(\tilde{\alpha}_{\sigma,j}) + \epsilon
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">alpha_std_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_stddev)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Parameter delta diagnostic: snapshot BEFORE M-step</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">params_before</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters_to_vector(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clone()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Inner M-step (recompute online outputs each iteration)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(int(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">m_steps)):</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_online,</span> <span style="color: #F8F8F2">log_std_online</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy(obs)</span>  <span style="color: #959077"># (B,D), (B,D)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">std_online</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(log_std_online)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># expand shapes for (B,N,D)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_online_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">mean_online</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">std_online_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">std_online</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_target_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">mean_target_det</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">std_target_exp</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">std_target_det</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unsqueeze(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># cross-entropy pieces</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_prob_fixed_stddev</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">Normal(mean_online_exp,</span> <span style="color: #F8F8F2">std_target_exp)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(actions_det)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_prob_fixed_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">Normal(mean_target_exp,</span> <span style="color: #F8F8F2">std_online_exp)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(actions_det)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">loss_policy_mean</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">(weights_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">log_prob_fixed_stddev)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">loss_policy_std</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">(weights_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">log_prob_fixed_mean)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">loss_policy</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">loss_policy_mean</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">loss_policy_std</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># KL penalties (compare online -&gt; frozen target)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kl_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_kl_diag_gaussian_per_dim(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">mean_target_det,</span> <span style="color: #F8F8F2">log_std_target_det,</span> <span style="color: #F8F8F2">mean_online,</span> <span style="color: #F8F8F2">log_std_target_det</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (B,D)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kl_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_kl_diag_gaussian_per_dim(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">mean_target_det,</span> <span style="color: #F8F8F2">log_std_target_det,</span> <span style="color: #F8F8F2">mean_target_det,</span> <span style="color: #F8F8F2">log_std_online</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (B,D)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_kl_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">kl_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (D,)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_kl_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">kl_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span>  <span style="color: #959077"># (D,)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">loss_kl_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(alpha_mean_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">mean_kl_mean)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">loss_kl_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(alpha_std_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">mean_kl_std)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">loss_kl_penalty</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">loss_kl_mean</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">loss_kl_std</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\pi}^{total} = \mathcal{L}_{\pi} + \mathcal{L}_{KL}
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">policy_total_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">loss_policy</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">loss_kl_penalty</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zero_grad()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">policy_total_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backward()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_grad_norm_(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># snapshot after M-step</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">params_after</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters_to_vector(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clone()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">param_delta</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">norm(params_after</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">params_before)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Increment step counter for target-sync cadence bookkeeping.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_num_steps</span> <span style="color: #FF4689">+=</span> <span style="color: #AE81FF">1</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Diagnostics for training monitoring.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_val</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">(F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{H}(q) = -\mathbb{E}_b\sum_i q_{b,i}\log q_{b,i}
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">entropy</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">(weights</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log(weights</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">))</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;train/param_delta&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(param_delta</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/q&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(q_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/policy&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(loss_policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/dual_eta&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(loss_temperature</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/dual&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(dual_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;kl/q_pi&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(kl_q_rel</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;kl/mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(mean_kl_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;kl/std&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(mean_kl_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;eta&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">temperature_val,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;lambda&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">(F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mean)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;alpha_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">(F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mean)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;alpha_std&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">(F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">softplus(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_stddev)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;q/min&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(q_vals</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">min()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;q/max&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(q_vals</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;pi/std_min&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(std_online</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">min()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;pi/std_max&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(std_online</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;entropy&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(entropy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">}</span></div>
</div>
