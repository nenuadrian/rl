# `trainers.vmpo.agent` Math-Annotated Source

_Source: `minerva/trainers/vmpo/agent.py`_

The full file is rendered in one continuous code-style block, with each `# LaTeX:` marker replaced inline by a rendered formula.

## Annotated Source

<div class="math-annotated-codeblock">
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> __future__ </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">annotations</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> typing </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">Tuple,</span> <span style="color: #F8F8F2">Dict,</span> <span style="color: #F8F8F2">Any,</span> <span style="color: #F8F8F2">Literal</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> numpy </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> np</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch.nn </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> nn</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">import</span><span style="color: #F8F8F2"> torch.nn.functional </span><span style="color: #66D9EF">as</span><span style="color: #F8F8F2"> F</span></div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> torch.distributions </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">Normal</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #FF4689">from</span><span style="color: #F8F8F2"> minerva.utils.running_norm </span><span style="color: #FF4689">import</span> <span style="color: #F8F8F2">RunningNorm</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">layer_init</span><span style="color: #F8F8F2">(layer:</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear,</span> <span style="color: #F8F8F2">std:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sqrt(</span><span style="color: #AE81FF">2.0</span><span style="color: #F8F8F2">),</span> <span style="color: #F8F8F2">bias_const:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">orthogonal_(layer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">weight,</span> <span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">init</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">constant_(layer</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">bias,</span> <span style="color: #F8F8F2">bias_const)</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">layer</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">DiagonalGaussianPolicy</span><span style="color: #F8F8F2">(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Module):</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">256</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">256</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">256</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">256</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">shared_encoder:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">super()</span><span style="color: #FF4689">.</span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">len(policy_layer_sizes)</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&quot;policy_layer_sizes must contain at least one layer size&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">len(value_layer_sizes)</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span><span style="color: #E6DB74">&quot;value_layer_sizes must contain at least one layer size&quot;</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shared_encoder</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">shared_encoder</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">RunningNorm(obs_dim)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_encoder</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_mlp(obs_dim,</span> <span style="color: #F8F8F2">policy_layer_sizes)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_encoder</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_encoder</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">shared_encoder</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">else</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_mlp(obs_dim,</span> <span style="color: #F8F8F2">value_layer_sizes)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">layer_init(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(policy_layer_sizes[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">],</span> <span style="color: #F8F8F2">act_dim),</span> <span style="color: #F8F8F2">std</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">0.01</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros(</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">act_dim))</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_head_in_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">policy_layer_sizes[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">shared_encoder</span> <span style="color: #66D9EF">else</span> <span style="color: #F8F8F2">value_layer_sizes[</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_head</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">layer_init(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(value_head_in_dim,</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">),</span> <span style="color: #F8F8F2">std</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #A6E22E">@staticmethod</span></div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_build_mlp</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">input_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">hidden_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Sequential:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">layers</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">last_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">input_dim</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">hidden_dim</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">hidden_layer_sizes:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">layers</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">extend([layer_init(nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Linear(last_dim,</span> <span style="color: #F8F8F2">hidden_dim)),</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tanh()])</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">last_dim</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">hidden_dim</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Sequential(</span><span style="color: #FF4689">*</span><span style="color: #F8F8F2">layers)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">policy_logstd_parameters</span><span style="color: #F8F8F2">(self)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">list[nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">[self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_mean_and_log_std</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">encoded_obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean(encoded_obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">expand_as(mean)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_policy_dist_params</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line"><span style="color: #F8F8F2">        </span><span style="color: #E6DB74">&quot;&quot;&quot;Internal helper to get raw distribution parameters.&quot;&quot;&quot;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">h</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_encoder(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_mean_and_log_std(h)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">forward</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get_policy_dist_params(obs)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_value</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shared_encoder:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">h</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_encoder(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">h</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_encoder(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_head(h)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">forward_all</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">obs_normalizer(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">h</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_encoder(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_mean_and_log_std(h)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">h_val</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">h</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shared_encoder</span> <span style="color: #66D9EF">else</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_encoder(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">v</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_head(h_val)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std,</span> <span style="color: #F8F8F2">v</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">log_prob</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">normal</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Normal(mean,</span> <span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">normal</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(actions)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">keepdim</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">sample_action</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">deterministic:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Tuple[torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Tensor]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">deterministic:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zeros((mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shape[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">],</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">),</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">normal</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Normal(mean,</span> <span style="color: #F8F8F2">std)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">normal</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_prob</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">normal</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(action)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">keepdim</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">action,</span> <span style="color: #F8F8F2">log_prob</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line"><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">VMPOAgent</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">__init__</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">act_dim:</span> <span style="color: #F8F8F2">int,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">device:</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">256</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">256</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_layer_sizes:</span> <span style="color: #F8F8F2">Tuple[int,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">256</span><span style="color: #F8F8F2">,</span> <span style="color: #AE81FF">256</span><span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">normalize_advantages:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">gamma:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.99</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">advantage_estimator:</span> <span style="color: #F8F8F2">Literal[</span><span style="color: #E6DB74">&quot;returns&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #E6DB74">&quot;dae&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #E6DB74">&quot;gae&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #E6DB74">&quot;returns&quot;</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">gae_lambda:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.95</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">5e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1e-3</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">topk_fraction:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.5</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_init:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">epsilon_eta:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.1</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">epsilon_mu:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.01</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">epsilon_sigma:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.01</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">alpha_lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1e-4</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">max_grad_norm:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">10.0</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">optimizer_type:</span> <span style="color: #F8F8F2">str</span> <span style="color: #FF4689">=</span> <span style="color: #E6DB74">&quot;adam&quot;</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">sgd_momentum:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.9</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">shared_encoder:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">m_steps:</span> <span style="color: #F8F8F2">int</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">):</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">device</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">normalize_advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">bool(normalize_advantages)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gamma</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(gamma)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">advantage_estimator</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">advantage_estimator</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">gae_lambda</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(gae_lambda)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(policy_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(value_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">topk_fraction</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(topk_fraction)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_init</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(temperature_init)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(temperature_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_eta</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(epsilon_eta)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_mu</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(epsilon_mu)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_sigma</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(epsilon_sigma)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">alpha_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(alpha_lr)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(max_grad_norm)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">str(optimizer_type)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sgd_momentum</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(sgd_momentum)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">m_steps</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(m_steps)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">DiagonalGaussianPolicy(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_dim</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">obs_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">act_dim</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">act_dim,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">policy_layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">policy_layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">value_layer_sizes</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">value_layer_sizes,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">shared_encoder</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">shared_encoder,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_params</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">list(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_head</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shared_encoder:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">value_params</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">list(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_encoder</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">value_params</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">policy_lr_eff</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_lr</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_lr_eff</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_lr</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">combined_opt</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_optimizer(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">[</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;params&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_encoder</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">policy_lr_eff,</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">},</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span><span style="color: #E6DB74">&quot;params&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters(),</span> <span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">policy_lr_eff},</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span><span style="color: #E6DB74">&quot;params&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd_parameters(),</span> <span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">policy_lr_eff},</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">{</span><span style="color: #E6DB74">&quot;params&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">value_params,</span> <span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">value_lr_eff},</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">opt</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">combined_opt</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Lagrange Multipliers (Dual Variables)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Temperature (eta) for advantage weighting: eta = exp(log_temperature)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_init_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_init,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">temperature_init_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clamp(temperature_init_t,</span> <span style="color: #F8F8F2">min</span><span style="color: #FF4689">=</span><span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log(temperature_init_t))</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eta_opt</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_optimizer(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">[self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature],</span> <span style="color: #F8F8F2">lr</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">temperature_lr</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># KL Penalties (alpha) for trust region: alpha = exp(log_alpha)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># exp(0.0) = 1.0</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mu</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_sigma</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Parameter(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(</span><span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">effective_alpha_lr</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">alpha_lr</span> <span style="color: #959077">#/ math.sqrt(self.m_steps)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">alpha_opt</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">_build_optimizer(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">[self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mu,</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_sigma],</span> <span style="color: #F8F8F2">lr</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">effective_alpha_lr</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">_build_optimizer</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span> <span style="color: #F8F8F2">params,</span> <span style="color: #F8F8F2">lr:</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">|</span> <span style="color: #66D9EF">None</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">None</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Optimizer:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optimizer_type</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">strip()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">lower()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">kwargs:</span> <span style="color: #F8F8F2">dict[str,</span> <span style="color: #F8F8F2">float]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">{}</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">lr</span> <span style="color: #FF4689">is</span> <span style="color: #FF4689">not</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kwargs[</span><span style="color: #E6DB74">&quot;lr&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(lr)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">==</span> <span style="color: #E6DB74">&quot;adam&quot;</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kwargs[</span><span style="color: #E6DB74">&quot;eps&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1e-5</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">Adam(params,</span> <span style="color: #FF4689">**</span><span style="color: #F8F8F2">kwargs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">optimizer_type</span> <span style="color: #FF4689">==</span> <span style="color: #E6DB74">&quot;sgd&quot;</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kwargs[</span><span style="color: #E6DB74">&quot;momentum&quot;</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sgd_momentum)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">optim</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">SGD(params,</span> <span style="color: #FF4689">**</span><span style="color: #F8F8F2">kwargs)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">act</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">deterministic:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">,</span></div>
  <div class="math-annotated-code-line">    <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Tuple[np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">float,</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray,</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">is_batch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndim</span> <span style="color: #FF4689">&gt;</span> <span style="color: #AE81FF">1</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">is_batch:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_np[</span><span style="color: #66D9EF">None</span><span style="color: #F8F8F2">,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">]</span>  <span style="color: #959077"># Add batch dim</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(obs_np,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean,</span> <span style="color: #F8F8F2">log_std,</span> <span style="color: #F8F8F2">value</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">forward_all(obs_t)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_t,</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_action(mean,</span> <span style="color: #F8F8F2">log_std,</span> <span style="color: #F8F8F2">deterministic)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">action_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">action_t</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">value_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">value</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">mean_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_std_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">is_batch:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">action_np[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">float(value_np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">mean_np[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">log_std_np[</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">],</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">action_np,</span> <span style="color: #F8F8F2">value_np,</span> <span style="color: #F8F8F2">mean_np,</span> <span style="color: #F8F8F2">log_std_np</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">value</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">obs:</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">float</span> <span style="color: #FF4689">|</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndarray:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">asarray(obs)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">is_batch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ndim</span> <span style="color: #FF4689">&gt;</span> <span style="color: #AE81FF">1</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">is_batch:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">obs_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">obs_np[</span><span style="color: #66D9EF">None</span><span style="color: #F8F8F2">,</span> <span style="color: #FF4689">...</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs_t</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">tensor(obs_np,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float32,</span> <span style="color: #F8F8F2">device</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">device)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">v</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get_value(obs_t)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">v_np</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">v</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">cpu()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numpy()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">is_batch:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">float(v_np</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item())</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">v_np</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">    <span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">update</span><span style="color: #F8F8F2">(self,</span> <span style="color: #F8F8F2">batch:</span> <span style="color: #F8F8F2">Dict[str,</span> <span style="color: #F8F8F2">Any])</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Dict[str,</span> <span style="color: #F8F8F2">float]:</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">obs</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch[</span><span style="color: #E6DB74">&quot;obs&quot;</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">actions</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch[</span><span style="color: #E6DB74">&quot;actions&quot;</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">old_means</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch[</span><span style="color: #E6DB74">&quot;old_means&quot;</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">old_log_stds</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch[</span><span style="color: #E6DB74">&quot;old_log_stds&quot;</span><span style="color: #F8F8F2">]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">returns_raw</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch[</span><span style="color: #E6DB74">&quot;returns&quot;</span><span style="color: #F8F8F2">]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch[</span><span style="color: #E6DB74">&quot;advantages&quot;</span><span style="color: #F8F8F2">]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">restarting_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get(</span><span style="color: #E6DB74">&quot;restarting_weights&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">importance_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">batch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get(</span><span style="color: #E6DB74">&quot;importance_weights&quot;</span><span style="color: #F8F8F2">,</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">restarting_weights</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">restarting_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones_like(advantages)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">restarting_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">restarting_weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">importance_weights</span> <span style="color: #FF4689">is</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">importance_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones_like(advantages)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">importance_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">importance_weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Advantage normalization</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">normalize_advantages:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\hat{A}_t = \frac{A_t - \mu_A}{\sigma_A + \epsilon}
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(advantages</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean())</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">std(unbiased</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Capture params before update for &#39;param_delta&#39;</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">params_before</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters_to_vector(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># ================================================================</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># E-Step: Re-weighting advantages (DeepMind-style semantics)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># ================================================================</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\eta = \exp(\log \eta)
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">eta</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
s_t = \frac{w_t^{restart}\hat{A}_t}{\eta}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">scaled_advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(restarting_weights</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">advantages)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">eta</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Numerical stability: subtract global max before exponentiation.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">max_scaled_advantage</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">scaled_advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #AE81FF">0.0</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">topk_fraction</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #E6DB74">f&quot;`topk_fraction` must be in (0, 1], got {</span><span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">topk_fraction</span><span style="color: #E6DB74">}&quot;</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">topk_fraction</span> <span style="color: #FF4689">&lt;</span> <span style="color: #AE81FF">1.0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">                <span style="color: #959077"># Exclude restarting states from top-k selection.</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">valid_scaled_advantages</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">scaled_advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clone()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">valid_scaled_advantages[restarting_weights</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">]</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">inf</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
k = \lfloor \rho N \rfloor
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">k</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">int(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">topk_fraction</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">valid_scaled_advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">numel())</span></div>
  <div class="math-annotated-code-line">                <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">k</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">raise</span> <span style="color: #A6E22E">ValueError</span><span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #E6DB74">&quot;topk_fraction too low to select any scaled advantages.&quot;</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">topk_vals,</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">topk(valid_scaled_advantages,</span> <span style="color: #F8F8F2">k)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
\tau = \min(\operatorname{TopK}(s, k))
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">threshold</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">topk_vals</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">min()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
m_t = \mathbf{1}[s_t \ge \tau]
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">topk_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(valid_scaled_advantages</span> <span style="color: #FF4689">&gt;=</span> <span style="color: #F8F8F2">threshold)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">to(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">restarting_weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">dtype</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
\bar{w}_t = w_t^{restart} \cdot m_t
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">topk_restarting_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">restarting_weights</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">topk_weights</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
\tau = \min_t s_t
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">threshold</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">scaled_advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">min()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
\bar{w}_t = w_t^{restart}
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">topk_restarting_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">restarting_weights</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Mask for selected samples (used for KL terms and diagnostics).</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mask_bool</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">topk_restarting_weights</span> <span style="color: #FF4689">&gt;</span> <span style="color: #AE81FF">0.0</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">bool(mask_bool</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">any()):</span></div>
  <div class="math-annotated-code-line">                <span style="color: #959077"># Fallback to avoid empty reductions on tiny rollouts.</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">mask_bool</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones_like(mask_bool,</span> <span style="color: #F8F8F2">dtype</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">bool)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">topk_restarting_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">ones_like(topk_restarting_weights)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Use stop-gradient semantics for importance weights.</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">importance_weights_sg</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">importance_weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\tilde{\psi}_t = \bar{w}_t \, w_t^{imp} \exp(s_t - s_{\max})
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">unnormalized_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">topk_restarting_weights</span></div>
  <div class="math-annotated-code-line">            <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">importance_weights_sg</span></div>
  <div class="math-annotated-code-line">            <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(scaled_advantages</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">max_scaled_advantage)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
Z = \sum_t \tilde{\psi}_t
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">sum_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">unnormalized_weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
N_{sel} = \sum_t \bar{w}_t
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">num_samples</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">topk_restarting_weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\psi_t = \frac{\tilde{\psi}_t}{Z}
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">unnormalized_weights</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">sum_weights</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">weights_detached</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">weights</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\log \bar{\psi} = \log Z + s_{\max} - \log N_{sel}
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">log_mean_weights</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log(sum_weights)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">max_scaled_advantage</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log(num_samples)</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 8ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\eta} = \eta \left(\epsilon_{\eta} + \log \bar{\psi}\right)
\]</div>
  </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">dual_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">eta</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_eta</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">log_mean_weights)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eta_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zero_grad()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">dual_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backward()</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">eta_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Compute Final Weights for Policy</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\eta&#x27; = \exp(\log \eta)
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">eta_final</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_temperature)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Logging: effective sample size and selection stats.</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">ess</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(weights_detached</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">pow(</span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-12</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">selected_frac</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(mask_bool</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item())</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">adv_std_over_temperature</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">std(unbiased</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(eta_final</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-12</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># ================================================================</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># M-Step: Policy &amp; Value Update</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># ================================================================</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">range(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">m_steps):</span>  <span style="color: #959077"># Multiple epochs of optimization per batch</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Run forward pass on ALL observations</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">current_mean,</span> <span style="color: #F8F8F2">current_log_std,</span> <span style="color: #F8F8F2">v_pred_fw</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">forward_all(obs)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">v_pred</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">v_pred_fw</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># -- Policy Loss --</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_prob</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_prob(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">current_mean,</span> <span style="color: #F8F8F2">current_log_std,</span> <span style="color: #F8F8F2">actions</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\pi}^{NLL} = -\sum_t \psi_t \log \pi_{\theta}(a_t|s_t)
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">weighted_nll</span> <span style="color: #FF4689">=</span> <span style="color: #FF4689">-</span><span style="color: #F8F8F2">(weights_detached</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">log_prob)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># -- KL Divergence (Full Batch Diagnostics) --</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># We compute this for logging purposes to see global drift</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">old_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">old_log_stds</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">new_std</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">current_log_std</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
D_{\mu}^{all} = \mathbb{E}\left[\sum_j \frac{(\mu_j-\mu_j^{old})^2}{2(\sigma_j^{old})^2}\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">kl_mean_all</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">((current_mean</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">old_means)</span> <span style="color: #FF4689">**</span> <span style="color: #AE81FF">2</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">2.0</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">old_std</span><span style="color: #FF4689">**</span><span style="color: #AE81FF">2</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">))</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 16ch;">
    <div class="arithmatex">\[
D_{\sigma}^{all} = \mathbb{E}\left[\frac{1}{2}\sum_j\left(\frac{(\sigma_j^{old})^2}{\sigma_j^2} - 1 + 2(\log \sigma_j - \log \sigma_j^{old})\right)\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">kl_std_all</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #AE81FF">0.5</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">(old_std</span><span style="color: #FF4689">**</span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(new_std</span><span style="color: #FF4689">**</span><span style="color: #AE81FF">2</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1.0</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #FF4689">+</span> <span style="color: #AE81FF">2.0</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(current_log_std</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">old_log_stds)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># -- KL Divergence (Selected Samples for Optimization) --</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">current_mean[mask_bool]</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">log_std_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">current_log_std[mask_bool]</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">old_mean_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">old_means[mask_bool]</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">old_log_std_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">old_log_stds[mask_bool]</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">old_std_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">old_log_std_sel</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">new_std_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">log_std_sel</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Decoupled KL</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
D_{\mu} = \mathbb{E}_{t \in \mathcal{S}}\left[\sum_j \frac{(\mu_j-\mu_j^{old})^2}{2(\sigma_j^{old})^2}\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kl_mu_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">0.5</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">((mean_sel</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">old_mean_sel)</span> <span style="color: #FF4689">**</span> <span style="color: #AE81FF">2</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(old_std_sel</span><span style="color: #FF4689">**</span><span style="color: #AE81FF">2</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)))</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
D_{\sigma} = \mathbb{E}_{t \in \mathcal{S}}\left[\frac{1}{2}\sum_j\left(\frac{(\sigma_j^{old})^2}{\sigma_j^2} - 1 + 2(\log \sigma_j - \log \sigma_j^{old})\right)\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">kl_sigma_sel</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #AE81FF">0.5</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #F8F8F2">(old_std_sel</span><span style="color: #FF4689">**</span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(new_std_sel</span><span style="color: #FF4689">**</span><span style="color: #AE81FF">2</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1.0</span></div>
  <div class="math-annotated-code-line">                        <span style="color: #FF4689">+</span> <span style="color: #AE81FF">2.0</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(log_std_sel</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">old_log_std_sel)</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(dim</span><span style="color: #FF4689">=-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># -- Alpha Optimization --</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\alpha_{\mu} = \exp(\log \alpha_{\mu})
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">alpha_mu</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mu)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\alpha_{\sigma} = \exp(\log \alpha_{\sigma})
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">alpha_sigma</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_sigma)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># We minimize: alpha * (epsilon - KL)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\alpha} = \alpha_{\mu}(\epsilon_{\mu} - D_{\mu}) + \alpha_{\sigma}(\epsilon_{\sigma} - D_{\sigma})
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">alpha_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">alpha_mu</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_mu</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">kl_mu_sel</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">alpha_sigma</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_sigma</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">kl_sigma_sel</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach())</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">alpha_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zero_grad()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">alpha_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backward()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">alpha_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># -- Final Policy Loss --</span></div>
  <div class="math-annotated-code-line">            <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">alpha_mu_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_mu)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">alpha_sigma_det</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">exp(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log_alpha_sigma)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{L}_{\pi} = \mathcal{L}_{\pi}^{NLL} + \alpha_{\mu}D_{\mu} + \alpha_{\sigma}D_{\sigma}
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">policy_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">weighted_nll</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(alpha_mu_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">kl_mu_sel)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(alpha_sigma_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">kl_sigma_sel)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># -- Critic Loss --</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{L}_{V} = \frac{1}{2}\mathbb{E}\left[(V_{\phi}(s_t) - R_t)^2\right]
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">value_loss</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">0.5</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">F</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mse_loss(v_pred,</span> <span style="color: #F8F8F2">returns_raw</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach())</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{L} = \mathcal{L}_{\pi} + \mathcal{L}_{V}
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">total_loss</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">policy_loss</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">value_loss</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">combined_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">zero_grad()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">total_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">backward()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">clip_grad_norm_(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">list(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_encoder</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">list(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_mean</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy_logstd_parameters()</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #F8F8F2">[]</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">shared_encoder</span></div>
  <div class="math-annotated-code-line">                    <span style="color: #66D9EF">else</span> <span style="color: #F8F8F2">list(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_encoder</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters())</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">                <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">list(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">value_head</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters()),</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">max_grad_norm,</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">combined_opt</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">step()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># ================================================================</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># Post-Update Diagnostics</span></div>
  <div class="math-annotated-code-line">        <span style="color: #959077"># ================================================================</span></div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">with</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">no_grad():</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># 1. Parameter Delta</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">params_after</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">nn</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">utils</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters_to_vector(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parameters()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">detach()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">param_delta</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">norm(params_after</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">params_before)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># 2. Explained Variance (Unnormalized)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">v_pred</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">get_value(obs)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">squeeze(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">y</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">returns_raw</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">var_y</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">y</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">var(unbiased</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\operatorname{EV} = 1 - \frac{\operatorname{Var}[R - V]}{\operatorname{Var}[R] + \epsilon}
\]</div>
  </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">explained_var</span> <span style="color: #FF4689">=</span> <span style="color: #AE81FF">1.0</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">(y</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">v_pred)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">var(unbiased</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">/</span> <span style="color: #F8F8F2">(var_y</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># 3. Action Saturation</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_eval,</span> <span style="color: #F8F8F2">log_std_eval</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy(obs)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">action_eval,</span> <span style="color: #F8F8F2">_</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">policy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sample_action(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">mean_eval,</span> <span style="color: #F8F8F2">log_std_eval,</span> <span style="color: #F8F8F2">deterministic</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">mean_abs_action</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">float(action_eval</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">abs()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item())</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line math-annotated-code-formula" style="--formula-indent: 12ch;">
    <div class="arithmatex">\[
\mathcal{H} = \mathbb{E}\left[\sum_j \frac{1}{2}\left(1 + \log(2\pi\sigma_j^2)\right)\right]
\]</div>
  </div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">entropy</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">0.5</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">(</span><span style="color: #AE81FF">1</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">log(</span><span style="color: #AE81FF">2</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">torch</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">pi</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">new_std_sel</span><span style="color: #FF4689">**</span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)))</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">sum(</span><span style="color: #FF4689">-</span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">)</span></div>
  <div class="math-annotated-code-line"> </div>
  <div class="math-annotated-code-line">        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">{</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/total&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(total_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/value&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(value_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/policy&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(policy_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/policy_weighted_nll&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(weighted_nll</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/policy_kl_mean_pen&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float((alpha_mu_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">kl_mu_sel)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/policy_kl_std_pen&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float((alpha_sigma_det</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">kl_sigma_sel)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;loss/alpha&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(alpha_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># KL Diagnostics</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;kl/mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(kl_mean_all</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;kl/std&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(kl_std_all</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;kl/mean_sel&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(kl_mu_sel</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;kl/std_sel&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(kl_sigma_sel</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Dual Variables</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/alpha_mu&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(alpha_mu_det</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/alpha_sigma&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(alpha_sigma_det</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/dual_loss&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(dual_loss</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/epsilon_eta&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(self</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epsilon_eta),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/temperature_raw&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(eta_final</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/adv_std_over_temperature&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(adv_std_over_temperature),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Selection Stats</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/selected_frac&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(selected_frac),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/threshold&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(threshold</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/ess&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(ess</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/restarting_frac&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(</span></div>
  <div class="math-annotated-code-line">                <span style="color: #F8F8F2">(restarting_weights</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #AE81FF">0.0</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">float()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()</span></div>
  <div class="math-annotated-code-line">            <span style="color: #F8F8F2">),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;vmpo/importance_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(importance_weights_sg</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Training Dynamics</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;train/entropy&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(entropy</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;train/param_delta&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(param_delta),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;train/mean_abs_action&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(mean_abs_action),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #959077"># Data Stats</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;adv/raw_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;adv/raw_std&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float((advantages</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">std(unbiased</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;returns/raw_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(returns_raw</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;returns/raw_std&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float((returns_raw</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">std(unbiased</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1e-8</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;value/explained_var&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(explained_var</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;value/pred_mean&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(v_pred</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">mean()</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">            <span style="color: #E6DB74">&quot;value/pred_std&quot;</span><span style="color: #F8F8F2">:</span> <span style="color: #F8F8F2">float(v_pred</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">std(unbiased</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">item()),</span></div>
  <div class="math-annotated-code-line">        <span style="color: #F8F8F2">}</span></div>
</div>
